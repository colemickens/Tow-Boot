From 878b3ea50f6f0a1b8f705187dbc4f395c9c687bd Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Kamil=20Trzci=C5=84ski?= <ayufan@ayufan.eu>
Date: Mon, 6 Apr 2020 11:36:42 +0200
Subject: [PATCH 1/3] ayufan: dwc3: of-simple: add `rockchip,rk3328-dwc3`

---
 drivers/usb/host/dwc3-of-simple.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/usb/host/dwc3-of-simple.c b/drivers/usb/host/dwc3-of-simple.c
index 66b3e96b007..6c4b5ef18d3 100644
--- a/drivers/usb/host/dwc3-of-simple.c
+++ b/drivers/usb/host/dwc3-of-simple.c
@@ -91,6 +91,7 @@ static int dwc3_of_simple_remove(struct udevice *dev)
 
 static const struct udevice_id dwc3_of_simple_ids[] = {
 	{ .compatible = "amlogic,meson-gxl-dwc3" },
+	{ .compatible = "rockchip,rk3328-dwc3" },
 	{ .compatible = "rockchip,rk3399-dwc3" },
 	{ .compatible = "ti,dwc3" },
 	{ }
-- 
2.35.1


From 2b59c201b0e75d98a61776f340be5296d8bc47d9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Kamil=20Trzci=C5=84ski?= <ayufan@ayufan.eu>
Date: Mon, 6 Apr 2020 12:52:29 +0200
Subject: [PATCH 2/3] ayufan: dts: rock64: configure vbus-supply on USB

---
 arch/arm/dts/rk3328-rock64-u-boot.dtsi | 1 +
 arch/arm/dts/rk3328-rock64.dts         | 4 ++--
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/arm/dts/rk3328-rock64-u-boot.dtsi b/arch/arm/dts/rk3328-rock64-u-boot.dtsi
index fe906e76a48..be1078ce16d 100644
--- a/arch/arm/dts/rk3328-rock64-u-boot.dtsi
+++ b/arch/arm/dts/rk3328-rock64-u-boot.dtsi
@@ -55,6 +55,7 @@
 &usb_host0_xhci {
 	vbus-supply = <&vcc_host_5v>;
 	status = "okay";
+	dr_mode = "host";
 };
 
 /*
diff --git a/arch/arm/dts/rk3328-rock64.dts b/arch/arm/dts/rk3328-rock64.dts
index f69a38f42d2..d04eb76dd63 100644
--- a/arch/arm/dts/rk3328-rock64.dts
+++ b/arch/arm/dts/rk3328-rock64.dts
@@ -43,8 +43,6 @@
 		pinctrl-names = "default";
 		pinctrl-0 = <&usb20_host_drv>;
 		regulator-name = "vcc_host_5v";
-		regulator-always-on;
-		regulator-boot-on;
 		vin-supply = <&vcc_sys>;
 	};
 
@@ -388,10 +386,12 @@
 
 &usb_host0_ehci {
 	status = "okay";
+	vbus-supply = <&vcc_host_5v>;
 };
 
 &usb_host0_ohci {
 	status = "okay";
+	vbus-supply = <&vcc_host_5v>;
 };
 
 &vop {
-- 
2.35.1


From 277dbac282011e149fbb83b3b6a78fa0482f4507 Mon Sep 17 00:00:00 2001
From: Samuel Dionne-Riel <samuel@dionne-riel.com>
Date: Fri, 17 Jun 2022 17:28:21 -0400
Subject: [PATCH 3/3] dts: rock64: apply configuration only to U-Boot FDT

---
 arch/arm/dts/rk3328-rock64-u-boot.dtsi | 8 ++++++++
 arch/arm/dts/rk3328-rock64.dts         | 4 ++--
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/arch/arm/dts/rk3328-rock64-u-boot.dtsi b/arch/arm/dts/rk3328-rock64-u-boot.dtsi
index be1078ce16d..9f4c7ca4a93 100644
--- a/arch/arm/dts/rk3328-rock64-u-boot.dtsi
+++ b/arch/arm/dts/rk3328-rock64-u-boot.dtsi
@@ -68,6 +68,14 @@
 	/delete-property/ regulator-boot-on;
 };
 
+&usb_host0_ehci {
+	vbus-supply = <&vcc_host_5v>;
+};
+
+&usb_host0_ohci {
+	vbus-supply = <&vcc_host_5v>;
+};
+
 /* Need this and all the pinctrl/gpio stuff above to set pinmux */
 &vcc_sd {
 	u-boot,dm-spl;
diff --git a/arch/arm/dts/rk3328-rock64.dts b/arch/arm/dts/rk3328-rock64.dts
index d04eb76dd63..f69a38f42d2 100644
--- a/arch/arm/dts/rk3328-rock64.dts
+++ b/arch/arm/dts/rk3328-rock64.dts
@@ -43,6 +43,8 @@
 		pinctrl-names = "default";
 		pinctrl-0 = <&usb20_host_drv>;
 		regulator-name = "vcc_host_5v";
+		regulator-always-on;
+		regulator-boot-on;
 		vin-supply = <&vcc_sys>;
 	};
 
@@ -386,12 +388,10 @@
 
 &usb_host0_ehci {
 	status = "okay";
-	vbus-supply = <&vcc_host_5v>;
 };
 
 &usb_host0_ohci {
 	status = "okay";
-	vbus-supply = <&vcc_host_5v>;
 };
 
 &vop {
-- 
2.35.1

